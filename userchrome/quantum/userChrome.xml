<?xml version="1.0"?>
<bindings id="generalBindings"
    xmlns="http://www.mozilla.org/xbl"
    xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul"
    xmlns:xbl="http://www.mozilla.org/xbl">
    <binding id="js" extends="chrome://global/content/bindings/toolbarbutton.xml#menu">
        <implementation>
            <constructor>
                <![CDATA[
                    function getAbsoluteFile(token)
                    {
                        try
                        {
                            return Components.classes["@mozilla.org/file/directory_service;1"]
                                .getService(Components.interfaces.nsIProperties)
                                .get(token, Components.interfaces.nsIFile);
                        }
                        catch (e)
                        {
                            console.log(`UserChrome.js - File not exists: ${token}`, e);
                            return null;
                        }
                    }

                    function getRelativePathURI(filename)
                    {
                        const absolutePath = Components.stack.filename;
                        return absolutePath.substring(0, absolutePath.lastIndexOf("/") + 1) + filename;
                    }

                    function importDirectory(directory)
                    {
                        if (directory && directory.isDirectory())
                        {
                            const files = directory.directoryEntries.QueryInterface(Components.interfaces.nsISimpleEnumerator);
                            while (files.hasMoreElements())
                            {
                                const file = files.getNext().QueryInterface(Components.interfaces.nsIFile);
                                if (file.leafName.endsWith(".uc.js"))
                                {
                                    loadScript(getRelativePathURI(file.leafName), file.leafName);
                                }
                            }
                        }
                    }

                    function loadScript(filepath, leafName)
                    {
                        try
                        {
                            Services.scriptloader.loadSubScriptWithOptions(filepath, {
                                charset: "UTF-8",
                                ignoreCache: true,
                                target: window
                            });
                            console.log(`UserChrome.js - ${leafName} is loaded.`);
                        }
                        catch (e)
                        {
                            console.log(`UserChrome.js - Failed to load script:\n${filepath}`, e);
                        }
                    }

                    // Import `*.uc.js` in `chrome` directory.
                    importDirectory(getAbsoluteFile("UChrm"));
                ]]>
            </constructor>
        </implementation>
    </binding>
</bindings>
